from .models import Blog
import re
import markdown
from services.generate import summarize_chunk,generate_blog, generate_card_topics, image_description, FourOImageAPI , RunwayAPI, generate_webpage  
import time

def generate_webpage_task(prompt, documents, language, webpage_prompt ,blog_id):
    blog = Blog.objects.get(id=blog_id)
    try:
        generated_blog = generate_webpage(prompt=prompt, docs=documents, setting_prompt=webpage_prompt, language=language)
        # time.sleep(5)
        # generated_blog = '## روندهای انرژی تجدیدپذیر در سال 2025\n\nانرژی\u200cهای تجدیدپذیر طی سال\u200cهای اخیر به یک محور اصلی در سیاست\u200cهای جهانی و توسعه پایدار تبدیل شده\u200cاند. با پیشرفت\u200cهای تکنولوژیکی، تغییرات جوی و فشارهای اقتصادی، جهان به سوی استفاده از منابع انرژی پاک\u200cتر و پایدارتر روی آورده است. در سال 2025، انتظار می\u200cرود که این روندها به شکل قابل توجهی تغییر کنند و نوآوری\u200cهایی در زمینه انرژی به وجود آید که نه تنها بر روی سیاست\u200cهای ملی تأثیر بگذارد بلکه بر روی سبک زندگی روزمره انسان\u200cها نیز تأثیرگذار باشد.\n\nتکنولوژی\u200cهای جدید بر پایه انرژی\u200cهای تجدیدپذیر به ما این امکان را می\u200cدهند که از منابعی چون خورشید، باد، آب و بیوماس استفاده بیشتری کنیم. در این راستا، پیشرفت\u200cها در زمینه ذخیره\u200cسازی انرژی و کارایی سیستم\u200cها به ما کمک خواهد کرد تا بتوانیم از این منابع به شکل مؤثرتری استفاده کنیم. با استفاده از انرژی تجدیدپذیر، جامعه\u200cای با انتشار کربن کمتر و محیط زیست پاک\u200cتر ساخته می\u200cشود.\n\nپیش\u200cبینی می\u200cشود که در سال 2025، انرژی خورشیدی و بادی به عنوان دو منبع اصلی انرژی تجدیدپذیر در بسیاری از کشورها شناخته شوند. این دو منبع قادر به تأمین بخش عمده\u200cای از نیازهای انرژی کشورهای پیشرفته و در حال توسعه خواهند بود و بدین ترتیب، همچنین موجب بهبود امنیت انرژی و کاهش وابستگی به سوخت\u200cهای فسیلی خواهند شد.\n\n![IMAGE_PROMPT: a futuristic solar panel farm with advanced technology, showcasing solar panels that track the sun and innovative wind turbines in the background](example.url)\n\n## پیشرفت\u200cهای فناوری و کاهش هزینه\u200cها\n\nیکی از عوامل کلیدی در رشد انرژی\u200cهای تجدیدپذیر در سال 2025، پیشرفت\u200cهای فناوری و کاهش هزینه\u200cها خواهد بود. با توسعه فناوری\u200cهای نوین مانند پنل\u200cهای خورشیدی با کارایی بالا و توربین\u200cهای بادی قوی\u200cتر، امکان تولید انرژی با هزینه\u200cهای کمتر فراهم خواهد شد. این پیشرفت\u200cها به ویژه در کشورهای در حال توسعه که به شدت به منابع انرژی جدید نیاز دارند، حائز اهمیت است.\n\nکاهش هزینه\u200cهای تولید و نصب پنل\u200cهای خورشیدی و تجهیزات بادی تنها یکی از جنبه\u200cهای این تحولات است. به عنوان مثال، بسیاری از شرکت\u200cها به بهینه\u200cسازی زنجیره تأمین خود پرداخته\u200cاند تا هزینه تمام\u200cشده تولید را به حداقل برسانند. در نتیجه، با کاهش هزینه، دسترسی به انرژی\u200cهای تجدیدپذیر برای عموم مردم آسان\u200cتر خواهد شد. این روند می\u200cتواند تأثیر زیادی بر پذیرش این نوع انرژی در سطح جامعه داشته باشد.\n\nدیگر جنبه مهم فناوری، بهبود روش\u200cهای ذخیره\u200cسازی انرژی است. با توسعه باتری\u200cهای کارآمدتر و سیستم\u200cهای ذخیره\u200cسازی بزرگ مقیاس، امکان استفاده از انرژی\u200cهای تجدیدپذیر به عنوان منبع اصلی تأمین انرژی فراهم می\u200cشود. به این ترتیب، نوسانات انرژی که به دلیل عدم ثبات در تولید منابع تجدیدپذیر به وجود می\u200cآید، به راحتی مدیریت خواهد شد و وابستگی به سوخت\u200cهای فسیلی به شدت کاهش می\u200cیابد.\n\n## پذیرش گسترده\u200cتر انرژی\u200cهای تجدیدپذیر\n\nیکی دیگر از روندهای قابل توجه در سال 2025، پذیرش گسترده\u200cتر انرژی\u200cهای تجدیدپذیر در صنایع و کسب\u200cوکارها خواهد بود. با توجه به فشارهای اجتماعی و اقتصادی برای کاهش انتشار کربن، شرکت\u200cها به سرعت به سمت استفاده از منابع انرژی پاک\u200cتر حرکت می\u200cکنند. این تغییرات نه تنها به آن\u200cها کمک می\u200cکند تا در راستای مسئولیت اجتماعی خود قدم بردارند بلکه همچنین می\u200cتواند هزینه\u200cها را کاهش دهد و مزیت\u200cهای رقابتی ایجاد کند.\n\nعلاوه بر این، بسیاری از صنایع به سمت عرضه انرژی\u200cهای تجدیدپذیر در محصولات و خدمات خود گام بر می\u200cدارند. به عنوان مثال، تولید خودروهای الکتریکی با استفاده از پنل\u200cهای خورشیدی برای شارژ و سیستم\u200cهای مدیریت هوشمند انرژی، روز به روز در حال گسترش است. این امر منجر به پیدایش نوآوری\u200cهای جدید و افزایش تقاضا برای انرژی\u200cهای پاک\u200cتر خواهد شد.\n\nسرمایه\u200cگذاری در زیرساخت\u200cهای انرژی تجدیدپذیر نیز در حال افزایش است. دولت\u200cها و نهادهای خصوصی به دنبال تأمین مالی پروژه\u200cهای انرژی پاک هستند تا به اهداف کاهش انتشار کربن و ایجاد محیط زیست سالم\u200cتر دست یابند. این روند به شکل\u200cگیری شبکه\u200cهای انرژی محلی و پایدار کمک می\u200cکند که می\u200cتواند به توسعه جوامع محلی و کاهش نابرابری\u200cهای اقتصادی منجر شود.\n\n![IMAGE_PROMPT: advanced renewable energy technology being adopted in an urban setting, showing electric vehicles charging at solar stations and buildings with green roofs](example.url)\n\n## چالش\u200cها و فرصت\u200cها\n\nاگرچه چشم\u200cانداز انرژی تجدیدپذیر در سال 2025 روشن به نظر می\u200cرسد، اما چالش\u200cهایی نیز وجود دارد که باید به آن\u200cها توجه شود. یکی از بزرگ\u200cترین چالش\u200cها، نیاز به اصلاحات قانونی و سیاست\u200cگذاری\u200cهای پایدار است. بسیاری از کشورها هنوز برای پذیرش انرژی\u200cهای تجدیدپذیر به اصلاحات اساسی نیاز دارند تا موانع موجود را برطرف کنند. همچنین، تغییر در رفتار مصرف\u200cکنندگان و عادت\u200cهای اجتماعی برای پذیرش این نوع انرژی لازم است.\n\nعلاوه بر این، تأمین مالی پروژه\u200cهای انرژی تجدیدپذیر در مناطق مختلف جهان یک چالش عمده به شمار می\u200cآید. کشورهای در حال توسعه به دلیل محدودیت\u200cهای مالی و دسترسی به منابع، ممکن است نتوانند به\u200cطور مؤثری از انرژی\u200cهای تجدیدپذیر بهره\u200cبرداری کنند. در این راستا، همکاری\u200cهای بین\u200cالمللی و ایجاد مدل\u200cهای مالی جدید می\u200cتواند به حل این مشکل کمک کند و به آنها ابتکار عمل در توسعه پایدار را بدهد.\n\nدر نهایت، چالش دیگری که باید به آن توجه شود، حفاظت از محیط زیست در هنگام استفاده از منابع تجدیدپذیر است. به عنوان مثال، پیاده\u200cسازی پروژه\u200cهای بزرگ بادی و خورشیدی ممکن است به اکوسیستم\u200cهای محلی آسیب برساند. بنابراین، در کنار خروج از سوخت\u200cهای فسیلی، ضروری است که رویکردی چندجانبه برای محافظت از منابع طبیعی و تنوع زیستی در پیش گرفته شود.\n\n## نتیجه\u200cگیری\n\nروندهای انرژی تجدیدپذیر در سال 2025 به شکل قابل توجهی منجر به تغییر شیوه تأمین انرژی در جهان خواهند شد. پیشرفت\u200cهای فناوری، پذیرش گسترده\u200cتر و سرمایه\u200cگذاری در زیرساخت\u200cها از جمله عواملی هستند که می\u200cتوانند نسل جدیدی از انرژی\u200cهای پاک و پایدار را به وجود آورند. در عین حال، اطمینان از توسعه پایدار و محافظت از محیط زیست از جمله چالش\u200cهایی است که باید بر آن فائق آمد.\n\nدر نهایت، انرژی\u200cهای تجدیدپذیر نه تنها به کاهش انتشار کربن و ایجاد جهانی پاک\u200cتر کمک می\u200cکنند بلکه می\u200cتوانند به ایجاد فرصت\u200cهای جدید شغلی و بهبود کیفیت زندگی در سراسر جهان بینجامند. با توجه به چالش\u200cها و فرصت\u200cها، آینده انرژی\u200cهای تجدیدپذیر بسیار امیدوارکننده به نظر می\u200cرسد و تمامی جوانب زندگی بشر را تحت تأثیر قرار خواهد داد.'

        parts = re.split(r'(!\[.*?\]\(.*?\))', generated_blog, flags=re.DOTALL)
        content = []
        for part in parts:
            if not part.strip():  # skip empty parts
                continue

            # Check if this part is an image
            match = re.match(r'!\[(.*?)\]\((.*?)\)', part)
            if match:
                alt_text = match.group(1)
                src = match.group(2)
                content.append({
                    "heading": "",
                    "body": "",
                    "media" : {"type":"image","prompt": alt_text, "url":"","Position":"top","Width":"100%","Height":"100%",'media_task_id':""}
                    
                })

            else:
                # Convert the Markdown text to HTML if you want, or keep as raw text
                html_text = markdown.markdown(part, extensions=["extra", "codehilite","toc"])
                content.append({
                    "heading": "",
                    "body": html_text,
                    "media" : {"type":"","prompt":"","url":"","Position":"top","Width":"100%","Height":"100%",'media_task_id':""}
                })

        content[0]['heading'] = content[0]['body'].split('\n')[0].strip()

        
        image_url = "https://res.cloudinary.com/dbezwpqgi/image/upload/v1/media/admin_images/pic_3_v0ij9t"
        print(content)
                
        
        blog.content = content
        blog.title = generated_blog.split('\n')[0].replace('#' , '').strip()
        blog.image_url = image_url
        blog.settings = {'containerWidth':'1000px', 'language':f"{'fa' if language == 'فارسی' else 'en'}",'theme':'purple-haze'}
        blog.blog_type = 'webpage'

        blog.save()
        print('saved')
    except Exception as e:
        print(e)
        blog.title = "failed"
        # blog.error_message = str(e)[:500]   # store useful info
        # blog.save()

        return "failed"
